{% extends 'subscriptions/base.html' %}
{% load static %}

{% block title %}Actualizar Método de Pago - Lyvio{% endblock %}

{% block extra_css %}
<style>
    .card-form-container {
        max-width: 600px;
        margin: 2rem auto;
    }
    
    .current-card-info {
        background: #f8f9fa;
        border-left: 4px solid #0d6efd;
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 0.25rem;
    }
    
    .current-card-info i {
        color: #0d6efd;
        font-size: 1.5rem;
        margin-right: 0.5rem;
    }
    
    .form-card {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card-input-group {
        margin-bottom: 1.5rem;
    }
    
    .card-input-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
    }
    
    .card-input-group input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }
    
    .card-input-group input:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }
    
    .card-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
    }
    
    .submit-btn {
        width: 100%;
        padding: 1rem;
        background: #0d6efd;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .submit-btn:hover {
        background: #0b5ed7;
    }
    
    .submit-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .cancel-btn {
        width: 100%;
        padding: 1rem;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        margin-top: 0.5rem;
    }
    
    .cancel-btn:hover {
        background: #5a6268;
        color: white;
    }
    
    .security-note {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
    }
    
    .security-note i {
        margin-right: 0.5rem;
    }
    
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .loading-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        text-align: center;
        max-width: 400px;
    }
    
    .loading-content .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0d6efd;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card-form-container">
        <h2 class="mb-4">
            <i class="fas fa-credit-card"></i>
            Actualizar Método de Pago
        </h2>
        
        {% if current_card %}
        <div class="current-card-info">
            <i class="fas fa-info-circle"></i>
            <strong>Tarjeta actual:</strong> {{ current_card.brand }} •••• {{ current_card.last_four }} 
            (Vence {{ current_card.exp_month }}/{{ current_card.exp_year }})
        </div>
        {% endif %}
        
        <div class="security-note">
            <i class="fas fa-shield-alt"></i>
            <strong>Seguro:</strong> Procesamos tu tarjeta a través de Wompi. No guardaremos tu información bancaria completa.
            Solo se tokenizará tu tarjeta, <strong>no se realizará ningún cobro</strong>.
        </div>
        
        <div class="form-card">
            <form method="POST" id="updateCardForm">
                {% csrf_token %}
                
                <div class="card-input-group">
                    <label for="card_number">
                        <i class="fas fa-credit-card"></i>
                        Número de Tarjeta
                    </label>
                    <input 
                        type="text" 
                        id="card_number" 
                        name="card_number" 
                        placeholder="1234 5678 9012 3456"
                        maxlength="19"
                        required
                    >
                </div>
                
                <div class="card-input-group">
                    <label for="card_holder">
                        <i class="fas fa-user"></i>
                        Nombre del Titular
                    </label>
                    <input 
                        type="text" 
                        id="card_holder" 
                        name="card_holder" 
                        placeholder="Como aparece en la tarjeta"
                        required
                    >
                </div>
                
                <div class="card-row">
                    <div class="card-input-group">
                        <label for="exp_month">
                            <i class="fas fa-calendar"></i>
                            Mes
                        </label>
                        <input 
                            type="text" 
                            id="exp_month" 
                            name="exp_month" 
                            placeholder="MM"
                            maxlength="2"
                            pattern="[0-9]{2}"
                            required
                        >
                    </div>
                    
                    <div class="card-input-group">
                        <label for="exp_year">Año</label>
                        <input 
                            type="text" 
                            id="exp_year" 
                            name="exp_year" 
                            placeholder="AA"
                            maxlength="2"
                            pattern="[0-9]{2}"
                            required
                        >
                    </div>
                    
                    <div class="card-input-group">
                        <label for="cvc">
                            <i class="fas fa-lock"></i>
                            CVC
                        </label>
                        <input 
                            type="text" 
                            id="cvc" 
                            name="cvc" 
                            placeholder="123"
                            maxlength="4"
                            pattern="[0-9]{3,4}"
                            required
                        >
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar Tarjeta
                </button>
                
                <a href="{% url 'dashboard:dashboard' %}" class="cancel-btn">
                    <i class="fas fa-times"></i>
                    Cancelar
                </a>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h4>Procesando...</h4>
        <p>Estamos validando y actualizando tu tarjeta de forma segura.</p>
        <p><strong>No se realizará ningún cobro.</strong></p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('updateCardForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const cardNumberInput = document.getElementById('card_number');
    const expMonthInput = document.getElementById('exp_month');
    const expYearInput = document.getElementById('exp_year');
    const cvcInput = document.getElementById('cvc');
    
    // Formatear número de tarjeta (agregar espacios cada 4 dígitos)
    cardNumberInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
    });
    
    // Solo números en mes, año y CVC
    [expMonthInput, expYearInput, cvcInput].forEach(input => {
        input.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
    });
    
    // Validar mes (01-12)
    expMonthInput.addEventListener('blur', function(e) {
        const month = parseInt(e.target.value);
        if (month < 1 || month > 12) {
            alert('Mes inválido. Ingresa un valor entre 01 y 12');
            e.target.value = '';
        } else if (e.target.value.length === 1) {
            e.target.value = '0' + e.target.value;
        }
    });
    
    // Submit del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validaciones adicionales
        const cardNumber = cardNumberInput.value.replace(/\s/g, '');
        if (cardNumber.length < 13 || cardNumber.length > 19) {
            alert('Número de tarjeta inválido');
            return;
        }
        
        const month = expMonthInput.value;
        const year = expYearInput.value;
        if (month.length !== 2 || year.length !== 2) {
            alert('Fecha de expiración inválida');
            return;
        }
        
        const cvc = cvcInput.value;
        if (cvc.length < 3 || cvc.length > 4) {
            alert('CVC inválido');
            return;
        }
        
        // Mostrar loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Procesando...';
        loadingOverlay.style.display = 'flex';
        
        // Enviar formulario
        form.submit();
    });
});
</script>
{% endblock %}
