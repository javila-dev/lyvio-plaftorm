{% extends 'subscriptions/base.html' %}
{% load humanize %}

{% block title %}Dashboard - {{ company.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">¬°Hola, {{ user.first_name|default:"Usuario" }}! üëã</h1>
                <p class="text-gray-600 text-lg">Aqu√≠ tienes un resumen de tu cuenta en <span class="font-semibold text-indigo-600">Lyvio</span></p>
            </div>
            
            {% if subscription %}
            <div class="flex-shrink-0">
                {% if subscription.status == 'active' %}
                    <div class="flex items-center gap-2 text-base px-6 py-3 font-semibold shadow-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full hover:scale-105 transition-transform">
                        <i class="fas fa-check-circle text-lg"></i>
                        <span>Activo</span>
                    </div>
                {% elif subscription.status == 'pending' %}
                    <div class="flex items-center gap-2 text-base px-6 py-3 font-semibold shadow-lg bg-gradient-to-r from-yellow-400 to-orange-400 text-white rounded-full hover:scale-105 transition-transform">
                        <i class="fas fa-hourglass-half text-lg"></i>
                        <span>Pago Pendiente</span>
                    </div>
                {% elif subscription.status == 'trial' %}
                    <div class="flex items-center gap-2 text-base px-6 py-3 font-semibold shadow-lg bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-full hover:scale-105 transition-transform">
                        <i class="fas fa-clock text-lg"></i>
                        <span>Per√≠odo de Prueba</span>
                    </div>
                {% elif subscription.status == 'cancelled' %}
                    <div class="flex items-center gap-2 text-base px-6 py-3 font-semibold shadow-lg bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-full hover:scale-105 transition-transform">
                        <i class="fas fa-times-circle text-lg"></i>
                        <span>Cancelado</span>
                    </div>
                {% elif subscription.status == 'expired' %}
                    <div class="flex items-center gap-2 text-base px-6 py-3 font-semibold shadow-lg bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-full hover:scale-105 transition-transform">
                        <i class="fas fa-exclamation-triangle text-lg"></i>
                        <span>Expirado</span>
                    </div>
                {% elif subscription.status == 'past_due' %}
                    <div class="flex items-center gap-2 text-base px-6 py-3 font-semibold shadow-lg bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-full hover:scale-105 transition-transform animate-pulse">
                        <i class="fas fa-exclamation-circle text-lg"></i>
                        <span>Pago Vencido</span>
                    </div>
                {% endif %}
            </div>
            {% elif trial %}
            <div class="flex-shrink-0">
                {% if trial_expired %}
                    <div class="flex items-center gap-2 text-base px-6 py-3 font-semibold shadow-lg bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-full hover:scale-105 transition-transform">
                        <i class="fas fa-exclamation-triangle text-lg"></i>
                        <span>Trial Expirado</span>
                    </div>
                {% else %}
                    <div class="flex items-center gap-2 text-base px-6 py-3 font-semibold shadow-lg bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-full hover:scale-105 transition-transform">
                        <i class="fas fa-clock text-lg"></i>
                        <span>Trial Activo</span>
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

{% if subscription %}

<!-- Alert para Suscripci√≥n Cancelada (Banner Superior) -->
{% if subscription.status == 'cancelled' %}
<div class="alert shadow-2xl mb-8 border-2 border-orange-300" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);">
    <div class="flex gap-4 items-center">
        <i class="fas fa-exclamation-circle text-4xl text-orange-600"></i>
        <div class="flex-grow">
            <h3 class="font-bold text-xl text-gray-800">Tu suscripci√≥n est√° cancelada</h3>
            <p class="text-sm mt-1 text-gray-700">
                {% if days_until_expiry >= 0 %}
                    A√∫n tienes acceso hasta el <strong>{{ next_billing_date|date:"j M Y" }}</strong> ({{ days_until_expiry }} d√≠a{{ days_until_expiry|pluralize }} restante{{ days_until_expiry|pluralize }}).
                    <br>
                    <span class="font-semibold">¬°Reactiva tu suscripci√≥n sin costo adicional!</span> Ya pagaste por este per√≠odo.
                {% else %}
                    Tu per√≠odo de acceso expir√≥ el <strong>{{ subscription.current_period_end|date:"j M Y" }}</strong>.
                    <br>
                    <span class="font-semibold">Renueva tu suscripci√≥n para recuperar el acceso completo.</span>
                {% endif %}
            </p>
        </div>
        {% if days_until_expiry >= 0 %}
            <a href="{% url 'dashboard:reactivate_subscription' %}" class="border-0 text-grey gap-2">
                <i class="fas fa-redo"></i>
                Reactivar Ahora
            </a>
        {% else %}
            <a href="{% url 'dashboard:renew_expired_subscription' %}" class="border-0 text-grey gap-2">
                <i class="fas fa-credit-card"></i>
                Renovar Suscripci√≥n
            </a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Stats Cards Grid -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Plan Actual Card -->
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300">
        <div class="card-body">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center">
                        <i class="fas fa-box text-indigo-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-600 text-sm">Plan Actual</h3>
                        <p class="text-2xl font-bold text-gray-800">{{ plan.name }}</p>
                    </div>
                </div>
                {% if subscription.status == 'active' %}
                <div class="badge badge-success gap-1">
                    <i class="fas fa-check-circle text-xs"></i>
                    <span class="text-xs">Activo</span>
                </div>
                {% elif subscription.status == 'suspended' %}
                <div class="badge badge-error gap-1">
                    <i class="fas fa-exclamation-triangle text-xs"></i>
                    <span class="text-xs">Suspendido</span>
                </div>
                {% elif subscription.status == 'pending' %}
                <div class="badge badge-warning gap-1">
                    <i class="fas fa-hourglass-half text-xs"></i>
                    <span class="text-xs">Pendiente</span>
                </div>
                {% elif subscription.status == 'trial' %}
                <div class="badge badge-info gap-1">
                    <i class="fas fa-clock text-xs"></i>
                    <span class="text-xs">Trial</span>
                </div>
                {% elif subscription.status == 'canceled' %}
                <div class="badge badge-ghost gap-1">
                    <i class="fas fa-ban text-xs"></i>
                    <span class="text-xs">Cancelado</span>
                </div>
                {% else %}
                <div class="badge badge-ghost gap-1">
                    <span class="text-xs">{{ subscription.status|title }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="flex items-end justify-between mt-4">
                <div>
                    <span class="text-3xl font-bold text-gray-800">${{ plan.price_monthly|floatformat:0|intcomma }}</span>
                    <span class="text-gray-500 text-sm ml-1">/mes</span>
                </div>
                <a href="{% url 'dashboard:plan_details' %}" class="btn btn-outline btn-primary btn-sm">
                    Ver Detalles
                </a>
            </div>
        </div>
    </div>
    
    <!-- Pr√≥ximo Pago Card -->
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center">
                    <i class="fas fa-calendar-alt text-green-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-600 text-sm">
                        {% if is_trial %}
                            Final del trial
                        {% else %}
                            Pr√≥ximo Pago
                        {% endif %}
                    </h3>
                    <p class="text-2xl font-bold text-gray-800">{{ next_billing_date|date:"j M Y" }}</p>
                </div>
            </div>
            
            <div class="mt-4">
                {% if days_until_expiry > 0 %}
                    <p class="text-gray-600">En <span class="font-semibold text-gray-800">{{ days_until_expiry }}</span> d√≠a{{ days_until_expiry|pluralize }}</p>
                {% elif days_until_expiry == 0 %}
                    <div class="alert alert-warning py-2">
                        <i class="fas fa-exclamation-circle"></i>
                        <span class="font-semibold">¬°Hoy!</span>
                    </div>
                {% else %}
                    <div class="alert alert-error py-2">
                        <i class="fas fa-times-circle"></i>
                        <span class="font-semibold">Vencido</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- √öltima Factura Card -->
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
                    <i class="fas fa-receipt text-blue-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-600 text-sm">√öltima Factura</h3>
                    {% if last_invoice %}
                        <p class="text-2xl font-bold text-gray-800">${{ last_invoice.amount|floatformat:0|intcomma }}</p>
                    {% else %}
                        <p class="text-lg font-semibold text-gray-400">Sin pagos</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="mt-4">
                {% if last_invoice %}
                    <p class="text-gray-600 text-sm">Pagado el {{ last_invoice.paid_at|date:"j M Y" }}</p>
                {% else %}
                    <p class="text-gray-500 text-sm">Sin pagos registrados</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- M√©todo de Pago e Informaci√≥n Fiscal -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- M√©todo de Pago Card -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex items-center justify-between mb-6">
                <h2 class="card-title text-xl font-bold">
                    <i class="fas fa-credit-card text-indigo-600"></i>
                    M√©todo de Pago
                </h2>
                <div class="flex gap-2">
                    {% if subscription and subscription.status == 'suspended' %}
                    <button type="button" class="btn btn-error btn-sm gap-2" id="retryPaymentBtn">
                        <i class="fas fa-redo" id="retryIcon"></i>
                        <span class="loading loading-spinner loading-sm hidden" id="retrySpinner"></span>
                        <span id="retryText">Reintentar Pago</span>
                    </button>
                    {% endif %}
                    <label for="updateCardDrawer" class="btn btn-outline btn-primary btn-sm gap-2 cursor-pointer">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </label>
                </div>
            </div>
            
            {% if subscription and subscription.payment_source_id and subscription.card_last_four %}
            <div class="flex items-center gap-4">
                <div class="text-5xl">
                    {% if subscription.card_brand == 'VISA' %}
                        <i class="fab fa-cc-visa text-blue-600"></i>
                    {% elif subscription.card_brand == 'MASTERCARD' %}
                        <i class="fab fa-cc-mastercard" style="color: #EB001B;"></i>
                    {% elif subscription.card_brand == 'AMEX' or subscription.card_brand == 'AMERICAN_EXPRESS' %}
                        <i class="fab fa-cc-amex" style="color: #006FCF;"></i>
                    {% elif subscription.card_brand == 'DINERS' or subscription.card_brand == 'DINERS_CLUB' %}
                        <i class="fab fa-cc-diners-club" style="color: #0079BE;"></i>
                    {% else %}
                        <i class="fas fa-credit-card text-gray-400"></i>
                    {% endif %}
                </div>
                <div class="flex-grow">
                    <p class="text-lg font-bold text-gray-800">{{ subscription.card_brand|title }} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ subscription.card_last_four }}</p>
                    <p class="text-gray-600 text-sm">
                        <i class="fas fa-calendar mr-1"></i>
                        Vence: {{ subscription.card_exp_month }}/{{ subscription.card_exp_year }}
                    </p>
                    <p class="text-success text-xs mt-1">
                        <i class="fas fa-shield-alt mr-1"></i>
                        Esta tarjeta se usa para cobros autom√°ticos
                    </p>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-credit-card text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500 mb-4">No hay un m√©todo de pago configurado.</p>
                <label for="updateCardDrawer" class="btn btn-primary btn-sm cursor-pointer">
                    Agregar M√©todo de Pago
                </label>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Informaci√≥n Fiscal Card -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex items-center justify-between mb-6">
                <h2 class="card-title text-xl font-bold">
                    <i class="fas fa-file-invoice-dollar text-indigo-600"></i>
                    Informaci√≥n Fiscal
                </h2>
                {% if company.billing_info %}
                    <a href="{% url 'dashboard:billing_info' %}" class="btn btn-outline btn-ghost btn-sm gap-2">
                        <i class="fas fa-edit"></i>
                        Editar
                    </a>
                {% else %}
                    <a href="{% url 'dashboard:billing_info' %}" class="btn btn-primary btn-sm gap-2">
                        <i class="fas fa-plus"></i>
                        Completar
                    </a>
                {% endif %}
            </div>
            
            {% if company.billing_info %}
            <div class="space-y-3">
                <div class="flex justify-between py-2 border-b border-gray-100">
                    <span class="text-gray-600 font-medium">Tipo de Persona</span>
                    <span class="text-gray-800">{{ company.billing_info.get_kind_of_person_display }}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-100">
                    <span class="text-gray-600 font-medium">Identificaci√≥n</span>
                    <span class="text-gray-800">{{ company.billing_info.id_type }} {{ company.billing_info.id_number }}{% if company.billing_info.id_dv %}-{{ company.billing_info.id_dv }}{% endif %}</span>
                </div>
                <div class="flex justify-between py-2">
                    <span class="text-gray-600 font-medium">Nombre</span>
                    <span class="text-gray-800">{{ company.billing_info.name }}</span>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">
                    <h3 class="font-bold"><i class="fas fa-exclamation-circle text-xl"></i><span> Informaci√≥n de facturaci√≥n incompleta</span></h3>
                    <p class="text-sm">Completa tus datos fiscales para poder activar suscripciones y generar facturas.</p>
                    
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Acciones R√°pidas -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    
    {% if subscription.status == 'cancelled' %}
    <!-- Reactivar Suscripci√≥n (para suscripciones canceladas) -->
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 border-2 border-transparent hover:border-green-200">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center animate-pulse">
                    <i class="fas fa-play-circle text-white text-2xl"></i>
                </div>
                <h3 class="card-title text-lg font-bold">Reactivar Plan</h3>
            </div>
            <p class="text-gray-600 text-sm mb-6 flex-grow">
                Tu suscripci√≥n est√° cancelada. React√≠vala para recuperar el acceso completo a todas las funcionalidades.
            </p>
            {% if days_until_expiry >= 0 %}
                <a href="{% url 'dashboard:reactivate_subscription' %}" class="border-0 text-grey gap-2">
                    <i class="fas fa-redo"></i>
                    Reactivar Ahora (Sin Costo)
                </a>
            {% else %}
                <a href="{% url 'dashboard:renew_expired_subscription' %}" class="border-0 text-grey gap-2">
                    <i class="fas fa-credit-card"></i>
                    Renovar Suscripci√≥n
                </a>
            {% endif %}
        </div>
    </div>
    {% else %}
    <!-- Actualizar Plan (para suscripciones activas) -->
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 border-2 border-transparent hover:border-green-200">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center">
                    <i class="fas fa-arrow-up text-white text-2xl"></i>
                </div>
                <h3 class="card-title text-lg font-bold">Actualizar Plan</h3>
            </div>
            <p class="text-gray-600 text-sm mb-6 flex-grow">
                ¬øNecesitas m√°s recursos? Actualiza tu plan para obtener m√°s inboxes, documentos y usuarios.
            </p>
            <a href="{% url 'dashboard:plan_details' %}" class="btn btn-success btn-block gap-2">
                <i class="fas fa-rocket"></i>
                Ver Planes Disponibles
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Historial de Pagos -->
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 border-2 border-transparent hover:border-blue-200">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                    <i class="fas fa-history text-white text-2xl"></i>
                </div>
                <h3 class="card-title text-lg font-bold">Historial de Pagos</h3>
            </div>
            <p class="text-gray-600 text-sm mb-6 flex-grow">
                Revisa todas tus facturas y pagos realizados.
            </p>
            <a href="{% url 'dashboard:payment_history' %}" class="btn btn-info btn-block gap-2">
                <i class="fas fa-file-invoice"></i>
                Ver Historial
            </a>
        </div>
    </div>
    
    {% if subscription.status != 'cancelled' %}
    <!-- Cancelar Suscripci√≥n (solo si NO est√° cancelada) -->
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 border-2 border-transparent hover:border-red-200">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center">
                    <i class="fas fa-times-circle text-white text-2xl"></i>
                </div>
                <h3 class="card-title text-lg font-bold">Cancelar Suscripci√≥n</h3>
            </div>
            <p class="text-gray-600 text-sm mb-6 flex-grow">
                Si deseas cancelar tu suscripci√≥n, puedes hacerlo desde aqu√≠.
            </p>
            <a href="{% url 'dashboard:cancel_subscription' %}" class="btn btn-error btn-block gap-2">
                <i class="fas fa-ban"></i>
                Cancelar Suscripci√≥n
            </a>
        </div>
    </div>
    {% endif %}
</div>

{% if is_trial %}
<!-- Alert para Trial Activo -->
<div class="alert alert-warning shadow-lg mb-8">
    <div class="flex gap-4">
        <i class="fas fa-exclamation-triangle text-3xl"></i>
        <div class="flex-grow">
            <h3 class="font-bold text-lg">¬°Per√≠odo de Prueba Activo!</h3>
            <p class="text-sm mt-1">
                Tu per√≠odo de prueba termina el <strong>{{ next_billing_date|date:"j M Y" }}</strong>. 
                {% if days_until_expiry <= 3 %}
                    <span class="font-bold">¬°Solo quedan {{ days_until_expiry }} d√≠a{{ days_until_expiry|pluralize }}!</span>
                {% endif %}
            </p>
        </div>
        <a href="{% url 'dashboard:plan_details' %}" class="btn btn-warning gap-2">
            <i class="fas fa-rocket"></i>
            Activar Suscripci√≥n
        </a>
    </div>
</div>
{% endif %}

{% else %}
<!-- Sin Suscripci√≥n Activa -->
{% if trial %}
<!-- Informaci√≥n del Trial - Card √önica -->
<div class="card bg-white shadow-xl mb-8 border-2 {% if trial_expired %}border-red-200{% else %}border-blue-200{% endif %}">
    <div class="card-body">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
            <!-- Izquierda: Estado y d√≠as -->
            <div class="flex items-start gap-4">
                <div class="w-16 h-16 rounded-2xl {% if trial_expired %}bg-gradient-to-br from-red-500 to-rose-600{% else %}bg-gradient-to-br from-blue-500 to-cyan-600{% endif %} flex items-center justify-center shadow-lg flex-shrink-0">
                    <i class="fas fa-{% if trial_expired %}exclamation-triangle{% else %}clock{% endif %} text-white text-3xl"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-slate-900 mb-2">
                        {% if trial_expired %}
                            Per√≠odo de Prueba Finalizado
                        {% else %}
                            Per√≠odo de Prueba Activo
                        {% endif %}
                    </h2>
                    {% if not trial_expired %}
                    <div class="flex items-center gap-2 mb-3">
                        <div class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold text-lg">
                            {{ trial_days_remaining }} d√≠a{{ trial_days_remaining|pluralize }} restante{{ trial_days_remaining|pluralize }}
                        </div>
                    </div>
                    {% endif %}
                    <p class="text-slate-600 text-base leading-relaxed">
                        {% if trial_expired %}
                            Tu cuenta y datos est√°n completamente seguros. Activa un plan para continuar disfrutando de todas las funcionalidades de Lyvio.
                        {% else %}
                            Explora todas las funcionalidades de Lyvio sin l√≠mites durante tu per√≠odo de prueba. Cuando est√©s listo, elige el plan que mejor se adapte a las necesidades de tu negocio.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Planes Disponibles -->
<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-400 to-purple-600 flex items-center justify-center">
                <i class="fas fa-rocket text-white text-2xl"></i>
            </div>
            <h2 class="card-title text-2xl">
                {% if trial_expired %}
                    Reactiva tu cuenta - Elige tu plan
                {% else %}
                    Contin√∫a con un plan completo
                {% endif %}
            </h2>
        </div>
        
        {% if trial_expired %}
        <div class="alert alert-info mb-6">
            <i class="fas fa-info-circle"></i>
            <div>
                <span class="font-bold">Tu per√≠odo de prueba ha finalizado.</span> Activa un plan para continuar usando todas las funcionalidades de Lyvio.
            </div>
        </div>
        {% endif %}
        
        <!-- Carrusel de Planes -->
        <div class="relative">
            <!-- Botones de navegaci√≥n -->
            <button id="scrollLeft" class="absolute left-0 top-1/2 -translate-y-1/2 z-20 w-14 h-14 rounded-full bg-white shadow-xl hover:bg-slate-50 border-2 border-slate-200 flex items-center justify-center transition-all hover:scale-110">
                <i class="fas fa-chevron-left text-xl text-slate-700"></i>
            </button>
            <button id="scrollRight" class="absolute right-0 top-1/2 -translate-y-1/2 z-20 w-14 h-14 rounded-full bg-white shadow-xl hover:bg-slate-50 border-2 border-slate-200 flex items-center justify-center transition-all hover:scale-110">
                <i class="fas fa-chevron-right text-xl text-slate-700"></i>
            </button>
            
            <!-- Gradiente difuminado a la derecha -->
            <div class="absolute top-0 right-0 bottom-0 w-32 bg-gradient-to-l from-white to-transparent z-10 pointer-events-none"></div>
            
            <div id="plansCarousel" class="overflow-x-auto pb-6 px-16" style="scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth;">
                <div class="flex gap-6 min-w-max mb-8">
                    {% for plan in available_plans %}
                    <div class="card bg-white border-2 {% if forloop.first %}border-indigo-500 shadow-xl{% else %}border-slate-200 shadow-lg{% endif %} hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 w-80 flex-shrink-0 {% if forloop.first %}relative overflow-hidden{% endif %}">
                        {% if forloop.first %}
                        <!-- Badge Popular m√°s moderno -->
                        <div class="absolute top-0 right-0">
                            <div class="relative">
                                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white px-6 py-2 rounded-bl-2xl font-bold text-sm shadow-lg">
                                    ‚≠ê M√ÅS POPULAR
                                </div>
                                <div class="absolute -bottom-2 right-0 w-0 h-0 border-t-8 border-t-purple-800 border-l-8 border-l-transparent"></div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="card-body">
                            <div class="mb-6 {% if forloop.first %}mt-8{% endif %}">
                                <h3 class="text-2xl font-bold text-slate-900 mb-3">{{ plan.name }}</h3>
                                <div class="flex items-baseline gap-1 mb-2">
                                    <span class="text-5xl font-bold text-slate-900">${{ plan.price_monthly|floatformat:0|intcomma }}</span>
                                    <span class="text-slate-600 text-lg font-medium">/mes</span>
                                </div>
                                {% if plan.price_yearly %}
                                <div class="inline-flex items-center gap-1.5 px-3 py-1 bg-emerald-50 text-emerald-700 rounded-lg text-sm font-semibold border border-emerald-200">
                                    <span>${{ plan.price_yearly|floatformat:0|intcomma }}/a√±o - Ahorra 20%</span>
                                </div>
                                {% endif %}
                            </div>
                    
                    <ul class="space-y-3 mb-6">
                        <li class="flex items-center gap-2 text-gray-700">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>{{ plan.max_inboxes }} inbox{{ plan.max_inboxes|pluralize }}</span>
                        </li>
                        <li class="flex items-center gap-2 text-gray-700">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>{{ plan.max_documents }} documento{{ plan.max_documents|pluralize }}</span>
                        </li>
                        <li class="flex items-center gap-2 text-gray-700">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>{{ plan.max_users }} usuario{{ plan.max_users|pluralize }}</span>
                        </li>
                        {% if plan.summary_features %}
                            {% for feature in plan.summary_features %}
                            <li class="flex items-center gap-2 text-gray-700">
                                <i class="fas fa-check-circle text-success"></i>
                                <span>{{ feature }}</span>
                            </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                    
                    <div class="flex justify-center">
                        <a href="{% url 'dashboard:activate_plan' plan.id %}" class="btn btn-primary btn-lg gap-2">
                            Activar Plan
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Informaci√≥n adicional -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card bg-gradient-to-br from-green-50 to-green-100 border border-green-200">
                <div class="card-body">
                    <h3 class="card-title text-green-700 font-bold text-lg">
                        <i class="fas fa-shield-alt"></i>
                        Garant√≠a de Satisfacci√≥n
                    </h3>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check text-green-600"></i>
                            Pago 100% seguro con Wompi
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check text-green-600"></i>
                            Activaci√≥n inmediata
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check text-green-600"></i>
                            Soporte t√©cnico incluido
                        </li>
                        <li class="flex items-center gap-2">
                            <i class="fas fa-check text-green-600"></i>
                            Cancela cuando quieras
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="card bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200">
                <div class="card-body">
                    <h3 class="card-title text-blue-700 font-bold text-lg">
                        <i class="fas fa-question-circle"></i>
                        ¬øNecesitas ayuda?
                    </h3>
                    <p class="text-sm text-gray-700 mb-4">Nuestro equipo est√° aqu√≠ para ayudarte a elegir el plan perfecto.</p>
                    <a href="mailto:soporte@lyvio.io" class="btn btn-outline btn-info btn-sm gap-2">
                        <i class="fas fa-envelope"></i>
                        Contactar Soporte
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

</div>
<!-- End of max-w-7xl container -->

<!-- Drawer para Actualizar Tarjeta (DaisyUI - equivalente al offcanvas) -->
{% if subscription and subscription.payment_source_id %}
<!-- Input checkbox oculto que controla el drawer -->
<input id="updateCardDrawer" type="checkbox" class="drawer-toggle hidden" />

<!-- Overlay oscuro que aparece cuando el drawer est√° abierto -->
<div class="drawer-overlay fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden" id="drawerOverlay"></div>

<!-- Panel del drawer que se desliza desde la derecha -->
<div class="fixed top-0 right-0 h-full w-[500px] max-w-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[110]" id="drawerPanel">
    <!-- Header con gradiente sticky -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 sticky top-0 z-10">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="font-bold text-2xl text-white mb-1">Actualizar M√©todo de Pago</h3>
                <p class="text-white/80 text-sm">üîí Pago seguro procesado por Wompi</p>
            </div>
            <label for="updateCardDrawer" class="btn btn-sm btn-circle btn-ghost text-white hover:bg-white/20 cursor-pointer">‚úï</label>
        </div>
    </div>
    
    <!-- Contenido del drawer con scroll -->
    <div class="p-6 overflow-y-auto bg-white" style="max-height: calc(100vh - 100px);">

        
        <!-- Formulario -->
        <form method="POST" action="{% url 'dashboard:update_payment_method' %}" id="updateCardForm">
            {% csrf_token %}
            
            <div class="mb-6">
                <label class="block mb-2">
                    <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">N√∫mero de Tarjeta</span>
                </label>
                <div class="relative">
                    <input 
                        type="text" 
                        class="input input-bordered w-full text-lg focus:input-primary" 
                        id="card_number" 
                        name="card_number" 
                        placeholder="1234 5678 9012 3456"
                        maxlength="19"
                        required
                    />
                    <div id="card_brand" class="absolute top-1/2 right-4 -translate-y-1/2 text-2xl opacity-70">
                        üí≥
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block mb-2">
                    <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">Nombre del Titular</span>
                </label>
                <input 
                    type="text" 
                    class="input input-bordered w-full text-lg focus:input-primary" 
                    id="card_holder" 
                    name="card_holder" 
                    placeholder="Como aparece en la tarjeta"
                    required
                />
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block mb-2">
                        <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">Mes</span>
                    </label>
                    <select 
                        class="select select-bordered w-full text-lg focus:select-primary" 
                        id="exp_month" 
                        name="exp_month" 
                        required
                    >
                        <option value="" disabled selected>mes</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                </div>
                
                <div>
                    <label class="block mb-2">
                        <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">A√±o</span>
                    </label>
                    <select 
                        class="select select-bordered w-full text-lg focus:select-primary" 
                        id="exp_year" 
                        name="exp_year" 
                        required
                    >
                        <option value="" disabled selected>a√±o</option>
                        <option value="25">2025</option>
                        <option value="26">2026</option>
                        <option value="27">2027</option>
                        <option value="28">2028</option>
                        <option value="29">2029</option>
                        <option value="30">2030</option>
                        <option value="31">2031</option>
                        <option value="32">2032</option>
                        <option value="33">2033</option>
                        <option value="34">2034</option>
                        <option value="35">2035</option>
                    </select>
                </div>
                
                <div>
                    <label class="block mb-2">
                        <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">CVC</span>
                    </label>
                    <input 
                        type="text" 
                        class="input input-bordered text-center text-lg focus:input-primary w-full" 
                        id="cvc" 
                        name="cvc" 
                        placeholder="123"
                        maxlength="4"
                        pattern="[0-9]{3,4}"
                        required
                    />
                </div>
            </div>
            
            <div class="flex flex-col gap-3 mt-6">
                <button type="submit" class="btn btn-primary btn-lg w-full gap-2" id="submitBtn">
                    <i class="fas fa-credit-card"></i>
                    <span id="submitBtnText">Actualizar M√©todo de Pago</span>
                </button>
                <label for="updateCardDrawer" class="btn btn-outline btn-lg w-full cursor-pointer">Cancelar</label>
            </div>
        </form>
        
    </div>
</div>

<!-- Loading Overlay -->
<div class="fixed inset-0 hidden items-center justify-center bg-black/75 backdrop-blur-sm z-[9999]" id="loadingOverlay">
    <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm">
        <div class="mb-6">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>
        <h5 class="text-xl font-bold text-gray-800 mb-2" id="loadingTitle">Procesando...</h5>
        <p class="text-gray-600 text-sm" id="loadingMessage">Estamos actualizando tu m√©todo de pago de forma segura.</p>
    </div>
</div>
{% endif %}

<script>
{% if subscription and subscription.payment_source_id %}
// Control del drawer - abrir/cerrar con animaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    const drawerCheckbox = document.getElementById('updateCardDrawer');
    const drawerPanel = document.getElementById('drawerPanel');
    const drawerOverlay = document.getElementById('drawerOverlay');
    
    // Funci√≥n para abrir el drawer
    function openDrawer() {
        drawerPanel.classList.remove('translate-x-full');
        drawerPanel.classList.add('translate-x-0');
        if (drawerOverlay) {
            drawerOverlay.classList.remove('hidden');
        }
        document.body.style.overflow = 'hidden'; // Prevenir scroll del body
    }
    
    // Funci√≥n para cerrar el drawer
    function closeDrawer() {
        drawerPanel.classList.remove('translate-x-0');
        drawerPanel.classList.add('translate-x-full');
        if (drawerOverlay) {
            drawerOverlay.classList.add('hidden');
        }
        document.body.style.overflow = ''; // Restaurar scroll del body
    }
    
    // Escuchar cambios en el checkbox
    drawerCheckbox.addEventListener('change', function() {
        if (this.checked) {
            openDrawer();
        } else {
            closeDrawer();
        }
    });
    
    // Cerrar con overlay
    if (drawerOverlay) {
        drawerOverlay.addEventListener('click', function() {
            drawerCheckbox.checked = false;
            closeDrawer();
        });
    }
    
    // Formulario de actualizaci√≥n de tarjeta
    const form = document.getElementById('updateCardForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const cardNumberInput = document.getElementById('card_number');
    const cardHolderInput = document.getElementById('card_holder');
    const expMonthInput = document.getElementById('exp_month');
    const expYearInput = document.getElementById('exp_year');
    const cvcInput = document.getElementById('cvc');
    
    // Detectar franquicia de tarjeta
    function detectCardBrand(number) {
        const cleaned = number.replace(/\s/g, '');
        
        // Visa
        if (/^4/.test(cleaned)) {
            return { icon: 'üí≥', name: 'Visa', color: '#1434CB' };
        }
        // Mastercard
        if (/^5[1-5]/.test(cleaned) || /^2[2-7]/.test(cleaned)) {
            return { icon: 'üí≥', name: 'Mastercard', color: '#EB001B' };
        }
        // American Express
        if (/^3[47]/.test(cleaned)) {
            return { icon: 'üí≥', name: 'Amex', color: '#006FCF' };
        }
        // Diners Club
        if (/^3(?:0[0-5]|[68])/.test(cleaned)) {
            return { icon: 'üí≥', name: 'Diners', color: '#0079BE' };
        }
        // Discover
        if (/^6(?:011|5)/.test(cleaned)) {
            return { icon: 'üí≥', name: 'Discover', color: '#FF6000' };
        }
        
        return { icon: 'üí≥', name: '', color: '#999' };
    }
    
    // Formatear n√∫mero de tarjeta (agregar espacios cada 4 d√≠gitos) y detectar marca
    cardNumberInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
        
        // Actualizar icono de marca
        const brand = detectCardBrand(value);
        const brandElement = document.getElementById('card_brand');
        if (brand.name) {
            brandElement.innerHTML = `<span style="color: ${brand.color}; font-weight: 600; font-size: 0.85rem;">${brand.name}</span>`;
        } else {
            brandElement.innerHTML = brand.icon;
        }
    });
    
    // Convertir nombre a may√∫sculas
    cardHolderInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
    
    // Solo n√∫meros en CVC (mes y a√±o ahora son selects)
    cvcInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    // Submit del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validaciones adicionales
        const cardNumber = cardNumberInput.value.replace(/\s/g, '');
        if (cardNumber.length < 13 || cardNumber.length > 19) {
            alert('N√∫mero de tarjeta inv√°lido. Debe tener entre 13 y 19 d√≠gitos.');
            cardNumberInput.focus();
            return;
        }
        
        const month = expMonthInput.value;
        const year = expYearInput.value;
        if (!month || !year) {
            alert('Por favor selecciona el mes y a√±o de expiraci√≥n');
            if (!month) expMonthInput.focus();
            else if (!year) expYearInput.focus();
            return;
        }
        
        const cvc = cvcInput.value;
        if (cvc.length < 3 || cvc.length > 4) {
            alert('CVC inv√°lido. Debe tener 3 o 4 d√≠gitos.');
            cvcInput.focus();
            return;
        }
        
        // Mostrar loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Procesando...';
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.classList.add('flex');
        
        // Actualizar mensaje del loading seg√∫n el estado de la suscripci√≥n
        const loadingTitle = document.getElementById('loadingTitle');
        const loadingMessage = document.getElementById('loadingMessage');
        {% if subscription.status == 'suspended' %}
        loadingTitle.textContent = 'Actualizando y reactivando...';
        loadingMessage.textContent = 'Estamos actualizando tu tarjeta y procesando el pago para reactivar tu cuenta.';
        {% else %}
        loadingTitle.textContent = 'Procesando...';
        loadingMessage.textContent = 'Estamos actualizando tu m√©todo de pago de forma segura.';
        {% endif %}
        
        // Enviar formulario
        form.submit();
    });
    
    // Resetear formulario al cerrar drawer
    drawerCheckbox.addEventListener('change', function() {
        if (!this.checked) {
            form.reset();
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-credit-card"></i> <span>Actualizar M√©todo de Pago</span>';
            closeDrawer();
        }
    });
});
{% endif %}

// Loading para bot√≥n de reintentar pago
document.addEventListener('DOMContentLoaded', function() {
    const retryBtn = document.getElementById('retryPaymentBtn');
    if (retryBtn) {
        retryBtn.addEventListener('click', function() {
            const btn = this;
            const spinner = document.getElementById('retrySpinner');
            const icon = document.getElementById('retryIcon');
            const text = document.getElementById('retryText');
            
            // Deshabilitar bot√≥n y mostrar loading
            btn.disabled = true;
            spinner.classList.remove('hidden');
            icon.classList.add('hidden');
            text.textContent = 'Procesando pago...';
            
            // Crear form y hacer submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "dashboard:retry_payment" %}';
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
        });
    }
});

// Carrusel de planes - Navegaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('plansCarousel');
    const scrollLeftBtn = document.getElementById('scrollLeft');
    const scrollRightBtn = document.getElementById('scrollRight');
    
    if (carousel && scrollLeftBtn && scrollRightBtn) {
        const scrollAmount = 350; // Ancho de card + gap
        
        scrollLeftBtn.addEventListener('click', function() {
            carousel.scrollBy({
                left: -scrollAmount,
                behavior: 'smooth'
            });
        });
        
        scrollRightBtn.addEventListener('click', function() {
            carousel.scrollBy({
                left: scrollAmount,
                behavior: 'smooth'
            });
        });
        
        // Ocultar/mostrar botones seg√∫n posici√≥n del scroll
        function updateButtons() {
            const isAtStart = carousel.scrollLeft <= 0;
            const isAtEnd = carousel.scrollLeft >= carousel.scrollWidth - carousel.clientWidth - 10;
            
            scrollLeftBtn.style.opacity = isAtStart ? '0.3' : '1';
            scrollLeftBtn.style.pointerEvents = isAtStart ? 'none' : 'auto';
            
            scrollRightBtn.style.opacity = isAtEnd ? '0.3' : '1';
            scrollRightBtn.style.pointerEvents = isAtEnd ? 'none' : 'auto';
        }
        
        carousel.addEventListener('scroll', updateButtons);
        updateButtons(); // Llamar al inicio
    }
});
</script>

{% endblock %}